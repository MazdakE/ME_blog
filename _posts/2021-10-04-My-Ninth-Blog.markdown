---
layout: post
title: "Ninth Blog Post"
subtitle: "Lecture 9 - Monitoring of cloud applications"
date: 2021-10-04 22:55
categories: jekyll update
---

# Introduction 

In this blog we are going to look at how we monitoring using our web app which we created from [Lecture 6](https://mazdake.github.io/ME_blog/jekyll/update/2021/09/24/My-Sixth-Blog.html). In our Azure Portal we use Application Insight to see activity results in Logs, analyzing peaks in App Service Overview and also displaying log using Serilog so that we can see the logging in our console when running our application. 

# Code

This section will only cover the logging code, the rest of the code is explianed in [Lecture 6](https://mazdake.github.io/ME_blog/jekyll/update/2021/09/24/My-Sixth-Blog.html). 

##### Startup.cs
To enable using server-side telemetry we first add the service provider and insert our intrument key to be retrieved from Configuration. We also add a singleton of Log.Logger so that we can use Serilog. See image below.  

![startupLogging](/ME_blog/images/Startup_logging.png){:class="img-fluid"}


##### Porgram.cs 

When our application starts, Program.cs is the first to run. He we create a fluent-api, first for Serilog just so that we cann log all the activities happening in our web app. This will also create a file.txt so that we can see all the activities done on specific time periods. We also insert our instrumentation key to display the activities from Application Insight. Those activities displayed with Serlog can also be found in your Azure Portal App Service -> Application Insight -> View Application Insights data -> Search -> See all data in the last 24 hours. See code below. 

<pre class="csharp" style="font-family:monospace;"><ol><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Microsoft.ApplicationInsights.Extensibility</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Microsoft.AspNetCore.Hosting</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Microsoft.Extensions.Configuration</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Microsoft.Extensions.Hosting</span><span style="color: #008000;">;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Microsoft.Extensions.Logging</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Serilog</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">Serilog.Events</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Collections.Generic</span><span style="color: #008000;">;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Linq</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">using</span> <span style="color: #008080;">System.Threading.Tasks</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #0600FF; font-weight: bold;">namespace</span> MusicAppWeb</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #6666cc; font-weight: bold;">class</span> Program</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> <span style="color: #6666cc; font-weight: bold;">int</span> Main<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span> args<span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            Log<span style="color: #008000;">.</span><span style="color: #0000FF;">Logger</span> <span style="color: #008000;">=</span> <span style="color: #008000;">new</span> LoggerConfiguration<span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">MinimumLevel</span><span style="color: #008000;">.</span><span style="color: #0600FF; font-weight: bold;">Override</span><span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;Microsoft&quot;</span>, LogEventLevel<span style="color: #008000;">.</span><span style="color: #0000FF;">Information</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">Enrich</span><span style="color: #008000;">.</span><span style="color: #0000FF;">FromLogContext</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">WriteTo</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Console</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">WriteTo</span><span style="color: #008000;">.</span><span style="color: #0000FF;">File</span><span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;file.txt&quot;</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">WriteTo</span><span style="color: #008000;">.</span><span style="color: #0000FF;">ApplicationInsights</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">new</span> TelemetryConfiguration <span style="color: #008000;">&#123;</span> InstrumentationKey <span style="color: #008000;">=</span> <span style="color: #666666;">&quot;INSERT INSTRUMENTATION KEY&quot;</span> <span style="color: #008000;">&#125;</span>, TelemetryConverter<span style="color: #008000;">.</span><span style="color: #0000FF;">Traces</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">CreateLogger</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #0600FF; font-weight: bold;">try</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                Log<span style="color: #008000;">.</span><span style="color: #0000FF;">Information</span><span style="color: #008000;">&#40;</span><span style="color: #666666;">&quot;Starting web host&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                CreateHostBuilder<span style="color: #008000;">&#40;</span>args<span style="color: #008000;">&#41;</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Build</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">.</span><span style="color: #0000FF;">Run</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #FF0000;">0</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #0600FF; font-weight: bold;">catch</span> <span style="color: #008000;">&#40;</span>Exception ex<span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                Log<span style="color: #008000;">.</span><span style="color: #0000FF;">Fatal</span><span style="color: #008000;">&#40;</span>ex, <span style="color: #666666;">&quot;Host terminated unexpectedly&quot;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #0600FF; font-weight: bold;">return</span> <span style="color: #FF0000;">1</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #0600FF; font-weight: bold;">finally</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                Log<span style="color: #008000;">.</span><span style="color: #0000FF;">CloseAndFlush</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            <span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">&nbsp;</div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #0600FF; font-weight: bold;">public</span> <span style="color: #0600FF; font-weight: bold;">static</span> IHostBuilder CreateHostBuilder<span style="color: #008000;">&#40;</span><span style="color: #6666cc; font-weight: bold;">string</span><span style="color: #008000;">&#91;</span><span style="color: #008000;">&#93;</span> args<span style="color: #008000;">&#41;</span> <span style="color: #008000;">=&gt;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">            Host<span style="color: #008000;">.</span><span style="color: #0000FF;">CreateDefaultBuilder</span><span style="color: #008000;">&#40;</span>args<span style="color: #008000;">&#41;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">ConfigureWebHostDefaults</span><span style="color: #008000;">&#40;</span>webBuilder <span style="color: #008000;">=&gt;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                    webBuilder<span style="color: #008000;">.</span><span style="color: #0000FF;">UseStartup</span><span style="color: #008000;">&lt;</span>Startup<span style="color: #008000;">&gt;</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">&#125;</span><span style="color: #008000;">&#41;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">                <span style="color: #008000;">.</span><span style="color: #0000FF;">UseSerilog</span><span style="color: #008000;">&#40;</span><span style="color: #008000;">&#41;</span><span style="color: #008000;">;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #008000;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #008000;">&#125;</span></div></li></ol></pre>

##### appsettings.json

In appsettings.json we simply set up the settings for Serilog defined in appsettings.json. **Line #3** marks the beginning of the Serilog Settings.
**Line #6 to #13** defined the minimum level of logging for various and default components. You can see that by default, we log all the levels above Information Log Level. But for specific components like Microsoft, we need to log only for the Warning and above levels, so that we don’t have a trillion lines of log in our sinks.

**Line #14 to 25** marks the Serilog Sink Settings. For now, we have written the settings for File and Console Sinks only. We will extend it further in this guide.
**Line #22** is where you can define the template of the log output.
**Line #26 to 31** defines the enrichers for Serilog to provide more details.
**Line #32 to 34** is where we can define custom properties that will appear in our structured log data.

<pre class="javascript" style="font-family:monospace;"><ol><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #3366CC;">&quot;AllowedHosts&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;*&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #3366CC;">&quot;Serilog&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;Using&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;Serilog.Sinks.ApplicationInsights&quot;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;MinimumLevel&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;Default&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Debug&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;Override&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #3366CC;">&quot;Microsoft&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Information&quot;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #009900;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;WriteTo&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #3366CC;">&quot;Name&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;ApplicationInsights&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #3366CC;">&quot;Args&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">          <span style="color: #3366CC;">&quot;instrumentationKey&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;INSERT INSTRUMENTATION KEY&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">          <span style="color: #3366CC;">&quot;telemetryConverter&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;Serilog.Sinks.ApplicationInsights.Sinks.ApplicationInsights.TelemetryConverters.TraceTelemetryConverter, Serilog.Sinks.ApplicationInsights&quot;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">        <span style="color: #009900;">&#125;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #009900;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;Enrich&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#91;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;FromLogContext&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;WithMachineName&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;WithProcessId&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;WithThreadId&quot;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #009900;">&#93;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;Properties&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">      <span style="color: #3366CC;">&quot;Application&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;CosmosWebApp&quot;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #009900;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #3366CC;">&quot;InstrumentationKey&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;INSERT INSTRUMENTATION KEY&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #3366CC;">&quot;CosmosDb&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;Account&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;https://musiccosmosdb.documents.azure.com:443/&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;Key&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;DatabaseName&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;MusicDb&quot;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;ContainerName&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;songs&quot;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #009900;">&#125;</span><span style="color: #339933;">,</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #3366CC;">&quot;ApplicationInsights&quot;</span><span style="color: #339933;">:</span> <span style="color: #009900;">&#123;</span></div></li><li style="font-weight: bold; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">    <span style="color: #3366CC;">&quot;ConnectionString&quot;</span><span style="color: #339933;">:</span> <span style="color: #3366CC;">&quot;InstrumentationKey=INSERT INSTRUMENTATION KEY;IngestionEndpoint=https://northeurope-2.in.applicationinsights.azure.com/&quot;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;">  <span style="color: #009900;">&#125;</span></div></li><li style="font-weight: normal; vertical-align:top;"><div style="font: normal normal 1em/1.2em monospace; margin:0; padding:0; background:none; vertical-align:top;"><span style="color: #009900;">&#125;</span></div></li></ol></pre>

Hope this part is clear. Let’s move forward and run the application.

##### LogInformation 

In out methods for post, get and delete we use `_logger.LogInformation("With some message")` to get a log when a specific method has been called. This will be shown in our logging. 

![LogInformation](/ME_blog/images/LogInformation.png){:class="img-fluid"}
_Image illustrates when the client is making a GET, the LogInformation will then be displayed in our logging_

# Diagram

The following diagram illustrates how the services are connected. 

![ServiceConnection](/ME_blog/images/ServiceConnection.drawio.png){:class="img-fluid"}

There is also graphical functions in Application Insight called [Application Map](https://docs.microsoft.com/sv-se/azure/azure-monitor/app/app-map?tabs=net). This will give you an overview over calls beeing made between Azure connected systems. This map finds components by following HTTP dependency calls between server and Application Insight. 

![ApplicationMap](/ME_blog/images/ApplicationMap.drawio.png){:class="img-fluid"}

# How it looks like when we run our application

![LoggingSeriLog](/ME_blog/images/LoggingSeriLog.png){:class="img-fluid"}

Now when we run the application locally we see get information about every step we take in our application. We see `[INF]` which means information and if it crashes we get `[ERR]` and `[WRN]`which means error and warning. Besides that we also get a text-file with all the information from the console everytime we use the application. 

We can on the other hand see the logging in Azure portal as I previously mentioned (App Service -> Application Insight -> View Application Insights data -> Search -> See all data in the last 24 hours). 

![LoggingInformation](/ME_blog/images/LoggingInformation.png){:class="img-fluid"}

And if click on one of those informations we can see the details about how long that specific request took, location from the client and more. 

# Telemetry

Telemetry simply gives you a set of plots which gives you all the information statistics. There is also Live Metrics which gives you a live update of plots. 

![LiveMetrics](/ME_blog/images/LiveMetrics.png){:class="img-fluid"}

# Queries

We use queries powered by [Kusto](https://docs.microsoft.com/sv-se/azure/data-explorer/kusto/query/) which works almost like SQL queries. We can retrieve data from our Azure resources. Below I will show one Kusto query as an example. 

![KustoQuery](/ME_blog/images/KustoQuery.png){:class="img-fluid"}

_Image illustrates filtering of start time, state and then counts how many that matches the given filters_

But in our case we used trace and then filtered it on decending order so that we can see the latest in View Logs in Azure Portal. See image below. 

![KustoQuery1](/ME_blog/images/KustoQuery1.png){:class="img-fluid"}

_Image illustrates the Kusto query we used to get the latest informations on top_

# Using logging to increase security

We will look at two effective logging strategies that will help increase dealing with compromises and also security. 

##### Audit trails

Audit trails are a record of changes that have been made to your data. Any change to data such as creating new data, updating data or deleting data is recorded. 

The need of such a record has to do with the security. Audit trail usually include identity of that user or the user who changed the data, date and what data has been changed. this information will ease the investigation and undo the damaged data. 

##### Threats

Threat logs trails suspicious activities or attemps that subvert the security of the application. These common threat logs include invalid parameters, unautorized access to restricted data, failed authentication, invalid API key and more. Just like audit trails, this can be used for investigation and also increase security. 

### Sources


##### >> [Logging in C#](https://michaelscodingspot.com/logging-in-dotnet/)

##### >> [What is Telemetry](https://stackify.com/telemetry-tutorial/)

##### >> [Metrics](https://docs.microsoft.com/en-gb/azure/azure-monitor/app/live-stream#get-started)

##### >> [Application Insight ASP.NET Core](https://docs.microsoft.com/en-us/azure/azure-monitor/app/asp-net-core)

##### >> [Application Insight Serilog Sink](https://www.youtube.com/watch?v=dI8-UHhiZZE)

##### >> [Serilog in ASP.NET](https://codewithmukesh.com/blog/serilog-in-aspnet-core-3-1/)

##### >> [Kusto Queries](https://azure-training.com/azure-data-science/the-kusto-query-language/)
